<?php
/**
 * Admin Login API Endpoint
 * File: C:\xampp\htdocs\Earth_mover\api\auth\admin_login.php
 * 
 * This file handles admin login requests from the Android app
 */

// Set headers for JSON response and CORS
header('Content-Type: application/json');
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: POST, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type');

// Handle preflight OPTIONS request
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit;
}

// Only allow POST requests
if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    http_response_code(405);
    echo json_encode([
        'success' => false,
        'message' => 'Method not allowed. Use POST.'
    ]);
    exit;
}

// Include database connection
// Adjust the path based on your file structure
$dbPath = __DIR__ . '/../config/database.php';
if (file_exists($dbPath)) {
    require_once $dbPath;
} else {
    // Try alternative path
    $dbPath = __DIR__ . '/../database.php';
    if (file_exists($dbPath)) {
        require_once $dbPath;
    } else {
        echo json_encode([
            'success' => false,
            'message' => 'Database configuration file not found'
        ]);
        exit;
    }
}

// Check if $conn is set and valid
if (!isset($conn) || $conn === null) {
    echo json_encode([
        'success' => false,
        'message' => 'Database connection error: Connection not established'
    ]);
    exit;
}

// Verify connection is still active
if ($conn->connect_error) {
    echo json_encode([
        'success' => false,
        'message' => 'Database connection error: ' . $conn->connect_error
    ]);
    exit;
}

// Get JSON input from request body
$json = file_get_contents('php://input');
$data = json_decode($json, true);

// Validate JSON input
if (!$data || json_last_error() !== JSON_ERROR_NONE) {
    echo json_encode([
        'success' => false,
        'message' => 'Invalid JSON input: ' . json_last_error_msg()
    ]);
    exit;
}

// Extract and validate input fields
$email = isset($data['email']) ? trim($data['email']) : '';
$password = isset($data['password']) ? $data['password'] : '';
$role = isset($data['role']) ? trim($data['role']) : 'admin';

// Validate required fields
if (empty($email)) {
    echo json_encode([
        'success' => false,
        'message' => 'Email is required'
    ]);
    exit;
}

if (empty($password)) {
    echo json_encode([
        'success' => false,
        'message' => 'Password is required'
    ]);
    exit;
}

// Validate email format
if (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
    echo json_encode([
        'success' => false,
        'message' => 'Invalid email format'
    ]);
    exit;
}

// Prepare SQL statement with prepared statement to prevent SQL injection
$sql = "SELECT admin_id, name, email, password FROM admins WHERE email = ? AND role = ?";
$stmt = $conn->prepare($sql);

if (!$stmt) {
    echo json_encode([
        'success' => false,
        'message' => 'Database query preparation failed: ' . $conn->error
    ]);
    exit;
}

// Bind parameters and execute
$stmt->bind_param("ss", $email, $role);
$stmt->execute();
$result = $stmt->get_result();

// Check if admin exists
if ($result->num_rows === 0) {
    echo json_encode([
        'success' => false,
        'message' => 'Invalid email or password'
    ]);
    $stmt->close();
    exit;
}

// Get admin data
$admin = $result->fetch_assoc();
$stmt->close();

// Verify password
// Assuming passwords are hashed using password_hash()
if (password_verify($password, $admin['password'])) {
    // Login successful
    echo json_encode([
        'success' => true,
        'ok' => true,
        'message' => 'Login successful',
        'data' => [
            'user_id' => (int)$admin['admin_id'],
            'name' => $admin['name'],
            'email' => $admin['email']
        ]
    ]);
} else {
    // Password incorrect
    echo json_encode([
        'success' => false,
        'message' => 'Invalid email or password'
    ]);
}

// Close database connection
$conn->close();
?>























